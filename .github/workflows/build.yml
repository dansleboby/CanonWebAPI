name: Build Canon.API

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Extract version from tag
      if: startsWith(github.ref, 'refs/tags/v')
      id: version
      run: |
        $tagName = "${{ github.ref }}" -replace 'refs/tags/v', ''
        echo "VERSION=$tagName" >> $env:GITHUB_OUTPUT
        echo "Tag version: $tagName"
      shell: powershell
        
    - name: Update Assembly Version
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # Update Canon.API AssemblyInfo
        $apiAssemblyInfo = "Canon.API/Properties/AssemblyInfo.cs"
        if (Test-Path $apiAssemblyInfo) {
          (Get-Content $apiAssemblyInfo) -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(""$version"")" -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(""$version"")" | Set-Content $apiAssemblyInfo
        }
        
        # Update Canon.Core AssemblyInfo
        $coreAssemblyInfo = "Canon.Core/Properties/AssemblyInfo.cs"
        if (Test-Path $coreAssemblyInfo) {
          (Get-Content $coreAssemblyInfo) -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(""$version"")" -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(""$version"")" | Set-Content $coreAssemblyInfo
        }
        
        # Update project files if they contain version
        Get-ChildItem -Recurse -Name "*.csproj" | ForEach-Object {
          $content = Get-Content $_
          if ($content -match "<Version>") {
            $content -replace "<Version>.*</Version>", "<Version>$version</Version>" | Set-Content $_
          }
        }
      shell: powershell
        
    - name: Restore dependencies
      run: dotnet restore CanonSDK.sln
      
    - name: Build solution
      run: dotnet build CanonSDK.sln --configuration Release --no-restore
      
    - name: Run tests (if any)
      run: dotnet test --configuration Release --no-build --verbosity normal
      continue-on-error: true
      
    - name: Publish Canon.API
      run: dotnet publish Canon.API --configuration Release --output ./publish --no-build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: canon-api-build
        path: ./publish/
        retention-days: 30
        
    - name: Create ZIP for release
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        Compress-Archive -Path "./publish/*" -DestinationPath "./CanonWebAPI-v$version.zip"
      shell: powershell
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./CanonWebAPI-v${{ steps.version.outputs.VERSION }}.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update GitHub Pages XML
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $releaseUrl = "https://github.com/${{ github.repository }}/releases/download/v$version/CanonWebAPI-v$version.zip"
        
        # Create docs folder if it doesn't exist
        if (!(Test-Path "docs")) {
          New-Item -ItemType Directory -Path "docs"
        }
        
        # Create AutoUpdater XML content
        $xmlContent = @"
        <?xml version="1.0" encoding="UTF-8"?>
        <item>
          <version>$version</version>
          <url>$releaseUrl</url>
          <changelog>https://github.com/${{ github.repository }}/releases/tag/v$version</changelog>
          <mandatory>false</mandatory>
        </item>
        "@
        
        $xmlContent | Out-File -FilePath "docs/autoupdate.xml" -Encoding UTF8
      shell: powershell
      
    - name: Commit and push XML changes
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/autoupdate.xml
        if (git diff --staged --quiet) {
          Write-Host "No changes to commit"
        } else {
          git commit -m "Update AutoUpdater XML for version ${{ steps.version.outputs.VERSION }}"
          git push
        }
      shell: powershell